
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/molml.jpg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-8.5.6">
    
    
      
        <title>s4_for_denovo_design - s4dd</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/style.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#s4_for_denovo_design" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="s4dd" class="md-header__button md-logo" aria-label="s4dd" data-md-component="logo">
      
  <img src="../../assets/molml.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            s4dd
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              s4_for_denovo_design
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/molML/s4-for-de-novo-drug-design/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="s4dd" class="md-nav__button md-logo" aria-label="s4dd" data-md-component="logo">
      
  <img src="../../assets/molml.jpg" alt="logo">

    </a>
    s4dd
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/molML/s4-for-de-novo-drug-design/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Homepage
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          s4_for_denovo_design
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        s4_for_denovo_design
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design" class="md-nav__link">
    s4dd.s4_for_denovo_design
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign" class="md-nav__link">
    S4forDenovoDesign
  </a>
  
    <nav class="md-nav" aria-label="S4forDenovoDesign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.compute_molecule_loglikelihoods" class="md-nav__link">
    compute_molecule_loglikelihoods()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.design_molecules" class="md-nav__link">
    design_molecules()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.from_file" class="md-nav__link">
    from_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel" class="md-nav__link">
    StructuredStateSpaceSequenceModel
  </a>
  
    <nav class="md-nav" aria-label="StructuredStateSpaceSequenceModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.recurrent_step" class="md-nav__link">
    recurrent_step()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.reset_state" class="md-nav__link">
    reset_state()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../torch_callbacks/" class="md-nav__link">
        torch_callbacks
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataloaders/" class="md-nav__link">
        dataloaders
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../smiles_utils/" class="md-nav__link">
        smiles_utils
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design" class="md-nav__link">
    s4dd.s4_for_denovo_design
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign" class="md-nav__link">
    S4forDenovoDesign
  </a>
  
    <nav class="md-nav" aria-label="S4forDenovoDesign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.compute_molecule_loglikelihoods" class="md-nav__link">
    compute_molecule_loglikelihoods()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.design_molecules" class="md-nav__link">
    design_molecules()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.from_file" class="md-nav__link">
    from_file()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.save" class="md-nav__link">
    save()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.S4forDenovoDesign.train" class="md-nav__link">
    train()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel" class="md-nav__link">
    StructuredStateSpaceSequenceModel
  </a>
  
    <nav class="md-nav" aria-label="StructuredStateSpaceSequenceModel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.forward" class="md-nav__link">
    forward()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.recurrent_step" class="md-nav__link">
    recurrent_step()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.reset_state" class="md-nav__link">
    reset_state()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/molML/s4-for-de-novo-drug-design/edit/master/docs/api/s4_for_denovo_design.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="s4_for_denovo_design">s4_for_denovo_design</h1>


<div class="doc doc-object doc-module">


<a id="s4dd.s4_for_denovo_design"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign">
        <code>S4forDenovoDesign</code>


</h2>


  <div class="doc doc-contents ">

  
      <p>A structured state space sequence (S4) model for de novo design.</p>


        <details class="quote">
          <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">S4forDenovoDesign</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A structured state space sequence (S4) model for de novo design.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
        <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">n_ssm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">37</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>
        <span class="n">n_max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates an `S4forDenovoDesign` instance.</span>
<span class="sd">        The default configurations are the ones used in the [paper](https://chemrxiv.org/engage/chemrxiv/article-details/65168004ade1178b24567cd3).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_dim : int</span>
<span class="sd">            The number of dimensions used across the model.</span>
<span class="sd">        state_dim : int</span>
<span class="sd">            The dimension of the state in the recurrent mode.</span>
<span class="sd">        n_layers : int</span>
<span class="sd">            The number of S4 layers in the model.</span>
<span class="sd">        n_ssm : int</span>
<span class="sd">            The number of state space models in each layer.</span>
<span class="sd">        dropout : float</span>
<span class="sd">            The dropout rate.</span>
<span class="sd">        vocab_size : int</span>
<span class="sd">            The size of the vocabulary.</span>
<span class="sd">        sequence_length : int</span>
<span class="sd">            The length of the sequences.</span>
<span class="sd">        n_max_epochs : int</span>
<span class="sd">            The maximum number of epochs to train for.</span>
<span class="sd">        learning_rate : float</span>
<span class="sd">            The learning rate.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            The batch size.</span>
<span class="sd">        device : str</span>
<span class="sd">            The device to put the model on, *e.g.,* `&quot;cuda&quot;` or `&quot;cpu&quot;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span> <span class="o">=</span> <span class="n">model_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">n_ssm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_max_epochs</span> <span class="o">=</span> <span class="n">n_max_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

        <span class="c1"># These are set during training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="n">StructuredStateSpaceSequenceModel</span><span class="p">(</span>
            <span class="n">model_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">,</span>
            <span class="n">state_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
            <span class="n">n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span>
            <span class="n">n_ssm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
            <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span>
            <span class="n">vocab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">loaddir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Loads an `S4forDenovoDesign` instance from a directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loaddir : str</span>
<span class="sd">            The directory to load the model from.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        S4forDenovoDesign</span>
<span class="sd">            The loaded model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loaddir</span><span class="si">}</span><span class="s2">/init_arguments.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">s4_model</span> <span class="o">=</span> <span class="n">StructuredStateSpaceSequenceModel</span><span class="p">(</span>
            <span class="n">model_dim</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;model_dim&quot;</span><span class="p">],</span>
            <span class="n">state_dim</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;state_dim&quot;</span><span class="p">],</span>
            <span class="n">n_layers</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;n_layers&quot;</span><span class="p">],</span>
            <span class="n">n_ssm</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;n_ssm&quot;</span><span class="p">],</span>
            <span class="n">dropout</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dropout&quot;</span><span class="p">],</span>
            <span class="n">learning_rate</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">],</span>
            <span class="n">sequence_length</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;sequence_length&quot;</span><span class="p">],</span>
            <span class="n">vocab_size</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">s4_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loaddir</span><span class="si">}</span><span class="s2">/model.pt&quot;</span><span class="p">))</span>
        <span class="n">token2label</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;token2label&quot;</span><span class="p">)</span>
        <span class="n">label2token</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label2token&quot;</span><span class="p">)</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">properties</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="n">s4_model</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">token2label</span> <span class="o">=</span> <span class="n">token2label</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">label2token</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="n">token</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">label2token</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">instance</span>

    <span class="k">def</span> <span class="nf">_compute_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_fn</span><span class="p">(</span>
            <span class="n">logits</span><span class="p">,</span>
            <span class="n">y</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">training_molecules_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">val_molecules_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch_callbacks</span><span class="o">.</span><span class="n">TorchCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Trains the model. The inputs are the paths to the training and validation molecules.</span>
<span class="sd">        The paths should point either to a .txt file that contains one SMILES per line, or to a zip file with the same structure.</span>
<span class="sd">        The optional callbacks can be used to monitor or configure training.</span>
<span class="sd">        The training history is returned as a dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        training_molecules_path : str</span>
<span class="sd">            The path to the training molecules. Can be a zip file or a text file. Must contain one SMILES string per line.</span>
<span class="sd">        val_molecules_path : str</span>
<span class="sd">            The path to the validation molecules. Must have the same structure as `training_molecules_path`.</span>
<span class="sd">        callbacks : List[torch_callbacks.TorchCallback], optional</span>
<span class="sd">            A list of callbacks to use during training. See the documentation of the `torch_callbacks` module for available options.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, List[float]]</span>
<span class="sd">            A dictionary containing the training history. The keys are `train_loss` and `val_loss` and the values are lists of the metric values at each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">create_dataloader</span><span class="p">(</span>
            <span class="n">training_molecules_path</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">token2label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span> <span class="o">=</span> <span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">token2label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">create_dataloader</span><span class="p">(</span>
            <span class="n">val_molecules_path</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">token2label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">()}</span>
        <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">epoch_ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_max_epochs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Training</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
            <span class="n">n_train_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
            <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">batch_train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_loss</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                <span class="n">epoch_train_loss</span> <span class="o">+=</span> <span class="n">batch_train_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">batch_train_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">epoch_train_loss</span> <span class="o">/</span> <span class="n">n_train_batches</span>
            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span>

            <span class="c1"># Validation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">n_val_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">)</span>
            <span class="n">epoch_val_loss</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="ow">in</span> <span class="n">val_dataloader</span><span class="p">:</span>
                <span class="n">batch_val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_loss</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
                <span class="n">epoch_val_loss</span> <span class="o">+=</span> <span class="n">batch_val_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="n">epoch_val_loss</span> <span class="o">=</span> <span class="n">epoch_val_loss</span> <span class="o">/</span> <span class="n">n_val_batches</span>
            <span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_val_loss</span><span class="p">)</span>

            <span class="c1"># Callbacks</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Epoch:</span><span class="si">{</span><span class="n">epoch_ix</span><span class="si">}</span><span class="se">\t</span><span class="s2">Loss: </span><span class="si">{</span><span class="n">epoch_train_loss</span><span class="si">}</span><span class="s2">, Val Loss: </span><span class="si">{</span><span class="n">epoch_val_loss</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                    <span class="n">callback</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">epoch_ix</span><span class="o">=</span><span class="n">epoch_ix</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
                <span class="n">stop_training_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">callback</span><span class="o">.</span><span class="n">stop_training</span> <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">]</span>
                <span class="n">stop_training</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">stop_training_flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">stop_training</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training stopped early. Epoch:&quot;</span><span class="p">,</span> <span class="n">epoch_ix</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">epoch_val_loss</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training diverged. Epoch:&quot;</span><span class="p">,</span> <span class="n">epoch_ix</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                <span class="n">callback</span><span class="o">.</span><span class="n">on_train_end</span><span class="p">(</span><span class="n">epoch_ix</span><span class="o">=</span><span class="n">epoch_ix</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">history</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">design_molecules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_designs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Designs molecules using the trained model. The number of designs to generate is specified by `n_designs`.</span>
<span class="sd">        The designs are generated in batches of size `batch_size`. The temperature is used to control the diversity of the generated designs.</span>
<span class="sd">        The designs and their log-likelihoods are returned as a tuple.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_designs : int</span>
<span class="sd">            The number of designs to generate.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            The batch size to use during generation.</span>
<span class="sd">        temperature : float</span>
<span class="sd">            The temperature to use during generation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[List[str], List[float]]</span>
<span class="sd">            A tuple containing the generated SMILES strings and their log-likelihoods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This model is untrained.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;setup_step&quot;</span><span class="p">):</span>
                <span class="n">module</span><span class="o">.</span><span class="n">setup_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="n">n_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_designs</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">designs</span><span class="p">,</span> <span class="n">likelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">==</span> <span class="n">n_batches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_designs</span> <span class="o">-</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">[</span><span class="s2">&quot;[BEG]&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">batch_designs</span><span class="p">,</span> <span class="n">batch_likelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">):</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">recurrent_step</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                <span class="n">softmax_preds</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">token_labels</span><span class="p">,</span> <span class="n">token_likelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">pred_idx</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preds</span><span class="p">):</span>
                    <span class="n">pred_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">pred_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pred_temperature</span><span class="p">)</span>
                    <span class="n">pred_normed</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">/</span> <span class="n">pred_sum</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pred_temperature</span><span class="p">]</span>
                    <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pred_normed</span><span class="p">)</span>
                    <span class="n">token_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>
                    <span class="n">token_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_label</span><span class="p">)</span>

                    <span class="n">token_likelihood</span> <span class="o">=</span> <span class="n">softmax_preds</span><span class="p">[</span><span class="n">pred_idx</span><span class="p">][</span><span class="n">token_label</span><span class="p">]</span>
                    <span class="n">token_likelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_likelihood</span><span class="p">)</span>

                <span class="n">batch_designs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_labels</span><span class="p">)</span>
                <span class="n">batch_likelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_likelihoods</span><span class="p">)</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">token_labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">designs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_designs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">likelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_likelihoods</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">designs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">designs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">molecules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">design</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;[BEG]&quot;</span><span class="p">,</span> <span class="s2">&quot;[END]&quot;</span><span class="p">,</span> <span class="s2">&quot;[PAD]&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span>
        <span class="p">]</span>
        <span class="n">molecule_lens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecules</span>
        <span class="p">]</span>  <span class="c1"># +2 for [BEG] and [END]</span>
        <span class="n">smiles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">]</span>
        <span class="n">loglikelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">mean_loglikelihoods</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ll</span><span class="p">[:</span> <span class="n">mol_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">mol_len</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loglikelihoods</span><span class="p">,</span> <span class="n">molecule_lens</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">mean_loglikelihoods</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">compute_molecule_loglikelihoods</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">molecules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Computes the log-likelihoods of a list of molecules. The molecules are processed in batches of size `batch_size`.</span>
<span class="sd">        The log-likelihoods are returned as a list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecules : List[List[str]]</span>
<span class="sd">            A list of SMILES strings.</span>
<span class="sd">            The input molecules are tokenized and padded (or truncated) internally to the sequence length used during training.</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            The batch size to use during computation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[float]</span>
<span class="sd">            A list of log-likelihoods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tokenized_molecules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;[BEG]&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">smiles_utils</span><span class="o">.</span><span class="n">segment_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;[END]&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">molecules</span>
        <span class="p">]</span>
        <span class="n">padded_molecules</span> <span class="o">=</span> <span class="n">smiles_utils</span><span class="o">.</span><span class="n">pad_sequences</span><span class="p">(</span>
            <span class="n">tokenized_molecules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="s2">&quot;[PAD]&quot;</span>
        <span class="p">)</span>
        <span class="n">label_encoded_molecules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span> <span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">padded_molecules</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;setup_step&quot;</span><span class="p">):</span>
                <span class="n">module</span><span class="o">.</span><span class="n">setup_step</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">n_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">all_sequence_loglikelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
            <span class="n">batch_start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">batch_end_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span>
            <span class="n">molecule_batch</span> <span class="o">=</span> <span class="n">label_encoded_molecules</span><span class="p">[</span><span class="n">batch_start_idx</span><span class="p">:</span><span class="n">batch_end_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">molecule_batch</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
            <span class="p">)</span>

            <span class="n">batch_loglikelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">):</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span><span class="p">[</span><span class="n">label_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecule_batch</span><span class="p">]</span>
                <span class="n">X_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">recurrent_step</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
                <span class="n">softmax_preds</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">log_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">softmax_preds</span><span class="p">)</span>

                <span class="n">next_token_labels</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">molecule</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecule_batch</span>
                <span class="p">]</span>
                <span class="n">log_likelihoods</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">log_pred</span><span class="p">[</span><span class="n">nt_label</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">nt_label</span><span class="p">,</span> <span class="n">log_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">next_token_labels</span><span class="p">,</span> <span class="n">log_preds</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">batch_loglikelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_likelihoods</span><span class="p">)</span>

            <span class="n">batch_loglikelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_loglikelihoods</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">molecule_lengths</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">tokenized_molecules</span><span class="p">[</span><span class="n">batch_start_idx</span><span class="p">:</span><span class="n">batch_end_idx</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">batch_sequence_loglikelihoods</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ll</span><span class="p">[:</span> <span class="n">mol_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">mol_len</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_loglikelihoods</span><span class="p">,</span> <span class="n">molecule_lengths</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">all_sequence_loglikelihoods</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_sequence_loglikelihoods</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_sequence_loglikelihoods</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the model to a directory. The directory will be created if it does not exist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The directory to save the model to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving model to&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/model.pt&quot;</span><span class="p">)</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s2">&quot;s4_model&quot;</span><span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/init_arguments.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">state_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_layers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_ssm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">vocab_size</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span> <span class="n">sequence_length</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">n_max_epochs</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Creates an <code>S4forDenovoDesign</code> instance.
The default configurations are the ones used in the <a href="https://chemrxiv.org/engage/chemrxiv/article-details/65168004ade1178b24567cd3">paper</a>.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of dimensions used across the model.</p></td>
          <td>
                <code>256</code>
          </td>
        </tr>
        <tr>
          <td><code>state_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The dimension of the state in the recurrent mode.</p></td>
          <td>
                <code>64</code>
          </td>
        </tr>
        <tr>
          <td><code>n_layers</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of S4 layers in the model.</p></td>
          <td>
                <code>4</code>
          </td>
        </tr>
        <tr>
          <td><code>n_ssm</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of state space models in each layer.</p></td>
          <td>
                <code>1</code>
          </td>
        </tr>
        <tr>
          <td><code>dropout</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The dropout rate.</p></td>
          <td>
                <code>0.25</code>
          </td>
        </tr>
        <tr>
          <td><code>vocab_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The size of the vocabulary.</p></td>
          <td>
                <code>37</code>
          </td>
        </tr>
        <tr>
          <td><code>sequence_length</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The length of the sequences.</p></td>
          <td>
                <code>99</code>
          </td>
        </tr>
        <tr>
          <td><code>n_max_epochs</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The maximum number of epochs to train for.</p></td>
          <td>
                <code>400</code>
          </td>
        </tr>
        <tr>
          <td><code>learning_rate</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The learning rate.</p></td>
          <td>
                <code>0.001</code>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size.</p></td>
          <td>
                <code>2048</code>
          </td>
        </tr>
        <tr>
          <td><code>device</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The device to put the model on, <em>e.g.,</em> <code>"cuda"</code> or <code>"cpu"</code>.</p></td>
          <td>
                <code>&#39;cuda&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
    <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">n_ssm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span>
    <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">37</span><span class="p">,</span>
    <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">99</span><span class="p">,</span>
    <span class="n">n_max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates an `S4forDenovoDesign` instance.</span>
<span class="sd">    The default configurations are the ones used in the [paper](https://chemrxiv.org/engage/chemrxiv/article-details/65168004ade1178b24567cd3).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_dim : int</span>
<span class="sd">        The number of dimensions used across the model.</span>
<span class="sd">    state_dim : int</span>
<span class="sd">        The dimension of the state in the recurrent mode.</span>
<span class="sd">    n_layers : int</span>
<span class="sd">        The number of S4 layers in the model.</span>
<span class="sd">    n_ssm : int</span>
<span class="sd">        The number of state space models in each layer.</span>
<span class="sd">    dropout : float</span>
<span class="sd">        The dropout rate.</span>
<span class="sd">    vocab_size : int</span>
<span class="sd">        The size of the vocabulary.</span>
<span class="sd">    sequence_length : int</span>
<span class="sd">        The length of the sequences.</span>
<span class="sd">    n_max_epochs : int</span>
<span class="sd">        The maximum number of epochs to train for.</span>
<span class="sd">    learning_rate : float</span>
<span class="sd">        The learning rate.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        The batch size.</span>
<span class="sd">    device : str</span>
<span class="sd">        The device to put the model on, *e.g.,* `&quot;cuda&quot;` or `&quot;cpu&quot;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span> <span class="o">=</span> <span class="n">model_dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">n_ssm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_max_epochs</span> <span class="o">=</span> <span class="n">n_max_epochs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="c1"># These are set during training</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="n">StructuredStateSpaceSequenceModel</span><span class="p">(</span>
        <span class="n">model_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">,</span>
        <span class="n">state_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
        <span class="n">n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span>
        <span class="n">n_ssm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign.compute_molecule_loglikelihoods">
<code class="highlight language-python"><span class="n">compute_molecule_loglikelihoods</span><span class="p">(</span><span class="n">molecules</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Computes the log-likelihoods of a list of molecules. The molecules are processed in batches of size <code>batch_size</code>.
The log-likelihoods are returned as a list.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>molecules</code></td>
          <td>
                <code><span title="typing.List">List</span>[<span title="typing.List">List</span>[str]]</code>
          </td>
          <td><p>A list of SMILES strings.
The input molecules are tokenized and padded (or truncated) internally to the sequence length used during training.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size to use during computation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[float]</code>
          </td>
          <td><p>A list of log-likelihoods.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">compute_molecule_loglikelihoods</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">molecules</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Computes the log-likelihoods of a list of molecules. The molecules are processed in batches of size `batch_size`.</span>
<span class="sd">    The log-likelihoods are returned as a list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    molecules : List[List[str]]</span>
<span class="sd">        A list of SMILES strings.</span>
<span class="sd">        The input molecules are tokenized and padded (or truncated) internally to the sequence length used during training.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        The batch size to use during computation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[float]</span>
<span class="sd">        A list of log-likelihoods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokenized_molecules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="s2">&quot;[BEG]&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">smiles_utils</span><span class="o">.</span><span class="n">segment_smiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;[END]&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">molecules</span>
    <span class="p">]</span>
    <span class="n">padded_molecules</span> <span class="o">=</span> <span class="n">smiles_utils</span><span class="o">.</span><span class="n">pad_sequences</span><span class="p">(</span>
        <span class="n">tokenized_molecules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding_value</span><span class="o">=</span><span class="s2">&quot;[PAD]&quot;</span>
    <span class="p">)</span>
    <span class="n">label_encoded_molecules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span> <span class="k">for</span> <span class="n">tokens</span> <span class="ow">in</span> <span class="n">padded_molecules</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;setup_step&quot;</span><span class="p">):</span>
            <span class="n">module</span><span class="o">.</span><span class="n">setup_step</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">molecules</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="n">all_sequence_loglikelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
        <span class="n">batch_start_idx</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">batch_end_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">molecule_batch</span> <span class="o">=</span> <span class="n">label_encoded_molecules</span><span class="p">[</span><span class="n">batch_start_idx</span><span class="p">:</span><span class="n">batch_end_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">molecule_batch</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="n">batch_loglikelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">label_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span><span class="p">[</span><span class="n">label_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecule_batch</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">recurrent_step</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            <span class="n">softmax_preds</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">log_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">softmax_preds</span><span class="p">)</span>

            <span class="n">next_token_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">molecule</span><span class="p">[</span><span class="n">label_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecule_batch</span>
            <span class="p">]</span>
            <span class="n">log_likelihoods</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">log_pred</span><span class="p">[</span><span class="n">nt_label</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">nt_label</span><span class="p">,</span> <span class="n">log_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">next_token_labels</span><span class="p">,</span> <span class="n">log_preds</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">batch_loglikelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_likelihoods</span><span class="p">)</span>

        <span class="n">batch_loglikelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_loglikelihoods</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">molecule_lengths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">tokenized_molecules</span><span class="p">[</span><span class="n">batch_start_idx</span><span class="p">:</span><span class="n">batch_end_idx</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">batch_sequence_loglikelihoods</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ll</span><span class="p">[:</span> <span class="n">mol_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">mol_len</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_loglikelihoods</span><span class="p">,</span> <span class="n">molecule_lengths</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">all_sequence_loglikelihoods</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">batch_sequence_loglikelihoods</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">all_sequence_loglikelihoods</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign.design_molecules">
<code class="highlight language-python"><span class="n">design_molecules</span><span class="p">(</span><span class="n">n_designs</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Designs molecules using the trained model. The number of designs to generate is specified by <code>n_designs</code>.
The designs are generated in batches of size <code>batch_size</code>. The temperature is used to control the diversity of the generated designs.
The designs and their log-likelihoods are returned as a tuple.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>n_designs</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of designs to generate.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size to use during generation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>temperature</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The temperature to use during generation.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[str], <span title="typing.List">List</span>[float]]</code>
          </td>
          <td><p>A tuple containing the generated SMILES strings and their log-likelihoods.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">design_molecules</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">n_designs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Designs molecules using the trained model. The number of designs to generate is specified by `n_designs`.</span>
<span class="sd">    The designs are generated in batches of size `batch_size`. The temperature is used to control the diversity of the generated designs.</span>
<span class="sd">    The designs and their log-likelihoods are returned as a tuple.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_designs : int</span>
<span class="sd">        The number of designs to generate.</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        The batch size to use during generation.</span>
<span class="sd">    temperature : float</span>
<span class="sd">        The temperature to use during generation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[List[str], List[float]]</span>
<span class="sd">        A tuple containing the generated SMILES strings and their log-likelihoods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This model is untrained.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;setup_step&quot;</span><span class="p">):</span>
            <span class="n">module</span><span class="o">.</span><span class="n">setup_step</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="n">n_batches</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_designs</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
    <span class="n">designs</span><span class="p">,</span> <span class="n">likelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_batches</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">==</span> <span class="n">n_batches</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_designs</span> <span class="o">-</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">[</span><span class="s2">&quot;[BEG]&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">reset_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">batch_designs</span><span class="p">,</span> <span class="n">batch_likelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">__</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">):</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">recurrent_step</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
            <span class="n">softmax_preds</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">token_labels</span><span class="p">,</span> <span class="n">token_likelihoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">pred_idx</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">preds</span><span class="p">):</span>
                <span class="n">pred_temperature</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">pred_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pred_temperature</span><span class="p">)</span>
                <span class="n">pred_normed</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">/</span> <span class="n">pred_sum</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pred_temperature</span><span class="p">]</span>
                <span class="n">probas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pred_normed</span><span class="p">)</span>
                <span class="n">token_label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probas</span><span class="p">)</span>
                <span class="n">token_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_label</span><span class="p">)</span>

                <span class="n">token_likelihood</span> <span class="o">=</span> <span class="n">softmax_preds</span><span class="p">[</span><span class="n">pred_idx</span><span class="p">][</span><span class="n">token_label</span><span class="p">]</span>
                <span class="n">token_likelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_likelihood</span><span class="p">)</span>

            <span class="n">batch_designs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_labels</span><span class="p">)</span>
            <span class="n">batch_likelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_likelihoods</span><span class="p">)</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">token_labels</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">designs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_designs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">likelihoods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">batch_likelihoods</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">designs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">designs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">molecules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">design</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;[BEG]&quot;</span><span class="p">,</span> <span class="s2">&quot;[END]&quot;</span><span class="p">,</span> <span class="s2">&quot;[PAD]&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span>
    <span class="p">]</span>
    <span class="n">molecule_lens</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecules</span>
    <span class="p">]</span>  <span class="c1"># +2 for [BEG] and [END]</span>
    <span class="n">smiles</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span> <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">molecules</span><span class="p">]</span>
    <span class="n">loglikelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">likelihoods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">mean_loglikelihoods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ll</span><span class="p">[:</span> <span class="n">mol_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">mol_len</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">loglikelihoods</span><span class="p">,</span> <span class="n">molecule_lens</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">mean_loglikelihoods</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign.from_file">
<code class="highlight language-python"><span class="n">from_file</span><span class="p">(</span><span class="n">loaddir</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Loads an <code>S4forDenovoDesign</code> instance from a directory.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>loaddir</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The directory to load the model from.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="s4dd.s4_for_denovo_design.S4forDenovoDesign" href="#s4dd.s4_for_denovo_design.S4forDenovoDesign">S4forDenovoDesign</a></code>
          </td>
          <td><p>The loaded model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">loaddir</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads an `S4forDenovoDesign` instance from a directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loaddir : str</span>
<span class="sd">        The directory to load the model from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    S4forDenovoDesign</span>
<span class="sd">        The loaded model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loaddir</span><span class="si">}</span><span class="s2">/init_arguments.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">s4_model</span> <span class="o">=</span> <span class="n">StructuredStateSpaceSequenceModel</span><span class="p">(</span>
        <span class="n">model_dim</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;model_dim&quot;</span><span class="p">],</span>
        <span class="n">state_dim</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;state_dim&quot;</span><span class="p">],</span>
        <span class="n">n_layers</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;n_layers&quot;</span><span class="p">],</span>
        <span class="n">n_ssm</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;n_ssm&quot;</span><span class="p">],</span>
        <span class="n">dropout</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dropout&quot;</span><span class="p">],</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">],</span>
        <span class="n">sequence_length</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;sequence_length&quot;</span><span class="p">],</span>
        <span class="n">vocab_size</span><span class="o">=</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vocab_size&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">s4_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loaddir</span><span class="si">}</span><span class="s2">/model.pt&quot;</span><span class="p">))</span>
    <span class="n">token2label</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;token2label&quot;</span><span class="p">)</span>
    <span class="n">label2token</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label2token&quot;</span><span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">properties</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="n">s4_model</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">token2label</span> <span class="o">=</span> <span class="n">token2label</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">label2token</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">):</span> <span class="n">token</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">label2token</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign.save">
<code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Saves the model to a directory. The directory will be created if it does not exist.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The directory to save the model to.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Saves the model to a directory. The directory will be created if it does not exist.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The directory to save the model to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving model to&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/model.pt&quot;</span><span class="p">)</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="s2">&quot;s4_model&quot;</span><span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/init_arguments.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.S4forDenovoDesign.train">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">training_molecules_path</span><span class="p">,</span> <span class="n">val_molecules_path</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Trains the model. The inputs are the paths to the training and validation molecules.
The paths should point either to a .txt file that contains one SMILES per line, or to a zip file with the same structure.
The optional callbacks can be used to monitor or configure training.
The training history is returned as a dictionary.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>training_molecules_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the training molecules. Can be a zip file or a text file. Must contain one SMILES string per line.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>val_molecules_path</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The path to the validation molecules. Must have the same structure as <code>training_molecules_path</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>callbacks</code></td>
          <td>
                <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="s4dd.torch_callbacks" href="../torch_callbacks/#s4dd.torch_callbacks">torch_callbacks</a>.<a class="autorefs autorefs-internal" title="s4dd.torch_callbacks.TorchCallback" href="../torch_callbacks/#s4dd.torch_callbacks.TorchCallback">TorchCallback</a>], optional</code>
          </td>
          <td><p>A list of callbacks to use during training. See the documentation of the <code>torch_callbacks</code> module for available options.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Dict">Dict</span>[str, <span title="typing.List">List</span>[float]]</code>
          </td>
          <td><p>A dictionary containing the training history. The keys are <code>train_loss</code> and <code>val_loss</code> and the values are lists of the metric values at each epoch.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">training_molecules_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">val_molecules_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch_callbacks</span><span class="o">.</span><span class="n">TorchCallback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Trains the model. The inputs are the paths to the training and validation molecules.</span>
<span class="sd">    The paths should point either to a .txt file that contains one SMILES per line, or to a zip file with the same structure.</span>
<span class="sd">    The optional callbacks can be used to monitor or configure training.</span>
<span class="sd">    The training history is returned as a dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    training_molecules_path : str</span>
<span class="sd">        The path to the training molecules. Can be a zip file or a text file. Must contain one SMILES string per line.</span>
<span class="sd">    val_molecules_path : str</span>
<span class="sd">        The path to the validation molecules. Must have the same structure as `training_molecules_path`.</span>
<span class="sd">    callbacks : List[torch_callbacks.TorchCallback], optional</span>
<span class="sd">        A list of callbacks to use during training. See the documentation of the `torch_callbacks` module for available options.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, List[float]]</span>
<span class="sd">        A dictionary containing the training history. The keys are `train_loss` and `val_loss` and the values are lists of the metric values at each epoch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">create_dataloader</span><span class="p">(</span>
        <span class="n">training_molecules_path</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">token2label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span> <span class="o">=</span> <span class="n">train_dataloader</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">token2label</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">label2token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">create_dataloader</span><span class="p">(</span>
        <span class="n">val_molecules_path</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">token2label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">token2label</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train_loss&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">()}</span>
    <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">epoch_ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_max_epochs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Training</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="n">n_train_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
        <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">batch_train_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_loss</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">epoch_train_loss</span> <span class="o">+=</span> <span class="n">batch_train_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">batch_train_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">epoch_train_loss</span> <span class="o">=</span> <span class="n">epoch_train_loss</span> <span class="o">/</span> <span class="n">n_train_batches</span>
        <span class="n">history</span><span class="p">[</span><span class="s2">&quot;train_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span>

        <span class="c1"># Validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s4_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">n_val_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_dataloader</span><span class="p">)</span>
        <span class="n">epoch_val_loss</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span> <span class="ow">in</span> <span class="n">val_dataloader</span><span class="p">:</span>
            <span class="n">batch_val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_loss</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">X_val</span><span class="p">,</span> <span class="n">y_val</span><span class="p">)</span>
            <span class="n">epoch_val_loss</span> <span class="o">+=</span> <span class="n">batch_val_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">epoch_val_loss</span> <span class="o">=</span> <span class="n">epoch_val_loss</span> <span class="o">/</span> <span class="n">n_val_batches</span>
        <span class="n">history</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch_val_loss</span><span class="p">)</span>

        <span class="c1"># Callbacks</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Epoch:</span><span class="si">{</span><span class="n">epoch_ix</span><span class="si">}</span><span class="se">\t</span><span class="s2">Loss: </span><span class="si">{</span><span class="n">epoch_train_loss</span><span class="si">}</span><span class="s2">, Val Loss: </span><span class="si">{</span><span class="n">epoch_val_loss</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                <span class="n">callback</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">epoch_ix</span><span class="o">=</span><span class="n">epoch_ix</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
            <span class="n">stop_training_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">callback</span><span class="o">.</span><span class="n">stop_training</span> <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">]</span>
            <span class="n">stop_training</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">stop_training_flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">stop_training</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training stopped early. Epoch:&quot;</span><span class="p">,</span> <span class="n">epoch_ix</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">epoch_train_loss</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">epoch_val_loss</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training diverged. Epoch:&quot;</span><span class="p">,</span> <span class="n">epoch_ix</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="o">.</span><span class="n">on_train_end</span><span class="p">(</span><span class="n">epoch_ix</span><span class="o">=</span><span class="n">epoch_ix</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">history</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">



<h2 class="doc doc-heading" id="s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel">
        <code>StructuredStateSpaceSequenceModel</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="torch.nn">nn</span>.<span title="torch.nn.Module">Module</span></code></p>

  
      <p>A general purpose structured state space sequence (S4) model implemented as a pytorch module.</p>


        <details class="quote">
          <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">StructuredStateSpaceSequenceModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A general purpose structured state space sequence (S4) model implemented as a pytorch module.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">n_ssm</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Creates a `StructuredStateSpaceSequenceModel` instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_dim : int</span>
<span class="sd">            The dimension of the model.</span>
<span class="sd">        state_dim : int</span>
<span class="sd">            The dimension of the state in recurrent mode.</span>
<span class="sd">        n_layers : int</span>
<span class="sd">            The number of S4 layers in the model.</span>
<span class="sd">        n_ssm : int</span>
<span class="sd">            The number of state space models in each layer.</span>
<span class="sd">        dropout : float</span>
<span class="sd">            The dropout rate.</span>
<span class="sd">        learning_rate : float</span>
<span class="sd">            The learning rate.</span>
<span class="sd">        sequence_length : int</span>
<span class="sd">            The length of the sequences.</span>
<span class="sd">        vocab_size : int</span>
<span class="sd">            The size of the vocabulary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span> <span class="o">=</span> <span class="n">model_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">n_ssm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layer_config</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;s4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;d_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
                <span class="s2">&quot;n_ssm&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;s4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;d_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
                <span class="s2">&quot;n_ssm&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span><span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;ff&quot;</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;pool&quot;</span><span class="p">,</span> <span class="s2">&quot;stride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SequenceModel</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">,</span>
            <span class="n">n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span>
            <span class="n">transposed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
            <span class="n">layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_config</span><span class="p">,</span>
            <span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_config</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Computes the forward pass of the model. The forward pass consists of embedding the</span>
<span class="sd">        input tokens, passing the embeddings through the S4 model (in convolutional mode), and then passing the</span>
<span class="sd">        output of the S4 model through a linear layer to get the logits.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        batch : torch.Tensor</span>
<span class="sd">            A batch of sequences of integers representing the tokens. The input shape is (batch_size, sequence_length, 1).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The logits of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">)</span>
        <span class="n">batch</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_embedding</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span>

    <span class="k">def</span> <span class="nf">reset_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Resets the recurrent state of the model.</span>
<span class="sd">        Used in sequential mode before processing a new batch.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        batch_size : int</span>
<span class="sd">            The batch size.</span>
<span class="sd">        device : str</span>
<span class="sd">            The device to put the state on, *e.g.,* `&quot;cuda&quot;` or `&quot;cpu&quot;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">default_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recurrent_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes a single step in the recurrent mode. The internal state of the model is also updated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_t : torch.Tensor</span>
<span class="sd">            The input token. The input shape is (batch_size, 1).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            The logits resulting from the stepping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">)</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x_t</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_embedding</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_t</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.__init__">
<code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_dim</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">n_ssm</span><span class="p">,</span> <span class="n">dropout</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Creates a <code>StructuredStateSpaceSequenceModel</code> instance.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>model_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The dimension of the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>state_dim</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The dimension of the state in recurrent mode.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>n_layers</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of S4 layers in the model.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>n_ssm</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The number of state space models in each layer.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>dropout</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The dropout rate.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>learning_rate</code></td>
          <td>
                <code>float</code>
          </td>
          <td><p>The learning rate.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>sequence_length</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The length of the sequences.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>vocab_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The size of the vocabulary.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">state_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_layers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">n_ssm</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dropout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Creates a `StructuredStateSpaceSequenceModel` instance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_dim : int</span>
<span class="sd">        The dimension of the model.</span>
<span class="sd">    state_dim : int</span>
<span class="sd">        The dimension of the state in recurrent mode.</span>
<span class="sd">    n_layers : int</span>
<span class="sd">        The number of S4 layers in the model.</span>
<span class="sd">    n_ssm : int</span>
<span class="sd">        The number of state space models in each layer.</span>
<span class="sd">    dropout : float</span>
<span class="sd">        The dropout rate.</span>
<span class="sd">    learning_rate : float</span>
<span class="sd">        The learning rate.</span>
<span class="sd">    sequence_length : int</span>
<span class="sd">        The length of the sequences.</span>
<span class="sd">    vocab_size : int</span>
<span class="sd">        The size of the vocabulary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span> <span class="o">=</span> <span class="n">model_dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span> <span class="o">=</span> <span class="n">state_dim</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span> <span class="o">=</span> <span class="n">n_ssm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">dropout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="n">learning_rate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">=</span> <span class="n">sequence_length</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">layer_config</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;s4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;d_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
            <span class="s2">&quot;n_ssm&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;s4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;d_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_dim</span><span class="p">,</span>
            <span class="s2">&quot;n_ssm&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_ssm</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;ff&quot;</span><span class="p">},</span>
    <span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pool_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_name_&quot;</span><span class="p">:</span> <span class="s2">&quot;pool&quot;</span><span class="p">,</span> <span class="s2">&quot;stride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">SequenceModel</span><span class="p">(</span>
        <span class="n">d_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">,</span>
        <span class="n">n_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="p">,</span>
        <span class="n">transposed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dropout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_config</span><span class="p">,</span>
        <span class="n">pool</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pool_config</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.forward">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Computes the forward pass of the model. The forward pass consists of embedding the
input tokens, passing the embeddings through the S4 model (in convolutional mode), and then passing the
output of the S4 model through a linear layer to get the logits.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>A batch of sequences of integers representing the tokens. The input shape is (batch_size, sequence_length, 1).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>The logits of the model.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Computes the forward pass of the model. The forward pass consists of embedding the</span>
<span class="sd">    input tokens, passing the embeddings through the S4 model (in convolutional mode), and then passing the</span>
<span class="sd">    output of the S4 model through a linear layer to get the logits.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    batch : torch.Tensor</span>
<span class="sd">        A batch of sequences of integers representing the tokens. The input shape is (batch_size, sequence_length, 1).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The logits of the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">)</span>
    <span class="n">batch</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_embedding</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.recurrent_step">
<code class="highlight language-python"><span class="n">recurrent_step</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Computes a single step in the recurrent mode. The internal state of the model is also updated.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x_t</code></td>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>The input token. The input shape is (batch_size, 1).</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>torch.<span title="torch.Tensor">Tensor</span></code>
          </td>
          <td><p>The logits resulting from the stepping.</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">recurrent_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes a single step in the recurrent mode. The internal state of the model is also updated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x_t : torch.Tensor</span>
<span class="sd">        The input token. The input shape is (batch_size, 1).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        The logits resulting from the stepping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dim</span><span class="p">)</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">x_t</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_embedding</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x_t</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="s4dd.s4_for_denovo_design.StructuredStateSpaceSequenceModel.reset_state">
<code class="highlight language-python"><span class="n">reset_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Resets the recurrent state of the model.
Used in sequential mode before processing a new batch.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>batch_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>The batch size.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>device</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>The device to put the state on, <em>e.g.,</em> <code>"cuda"</code> or <code>"cpu"</code>.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>s4dd/s4_for_denovo_design.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Resets the recurrent state of the model.</span>
<span class="sd">    Used in sequential mode before processing a new batch.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    batch_size : int</span>
<span class="sd">        The batch size.</span>
<span class="sd">    device : str</span>
<span class="sd">        The device to put the state on, *e.g.,* `&quot;cuda&quot;` or `&quot;cpu&quot;`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">default_state</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../.." class="md-footer__link md-footer__link--prev" aria-label="Previous: Homepage" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Homepage
            </div>
          </div>
        </a>
      
      
        
        <a href="../torch_callbacks/" class="md-footer__link md-footer__link--next" aria-label="Next: torch_callbacks" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              torch_callbacks
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.078830c0.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>